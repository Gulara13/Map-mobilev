<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Baku Once Upon a Time — Mobil</title>
  <style>
    :root{
      --ink:#111827; --muted:#6b7280; --ring:#93c5fd;
      --card:#ffffff; --bg:#ffffff;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    html,body{margin:0; height:100%; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}

    .app{display:flex; flex-direction:column; min-height:100dvh; max-width:600px; margin:0 auto;}
    header{padding:10px 12px 6px; text-align:center;}
    header h1{margin:0; font-size:18px; font-weight:800;}
    header p.sub{margin:4px 0 0; font-size:13px; color:#374151;}

    /* Xəritə sahəsi */
    .map{position:relative; width:100%; height:60dvh; overflow:hidden; background:#fff;
         border-top:1px solid #eee; border-bottom:1px solid #eee;}
    .map img.bg{position:absolute; inset:0; width:100%; height:100%; object-fit:contain; z-index:0; user-select:none; pointer-events:none;}
    .pins{ position:absolute; inset:0; z-index:1; }

    /* Marker (pin) */
    .pin{
      position:absolute; width:36px; height:36px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background:#111; color:#f5d7b5; font-size:14px; font-weight:700;
      box-shadow:0 6px 16px rgba(0,0,0,.18);
      transform:translate(-50%,-50%); /* koordinatı mərkəzə gətirir */
      touch-action:none; /* pointer sürüşdürməsində lazımdır */
    }
    .pin.active{ outline:3px solid var(--ring); background:#000; color:#fff; }
    .pin.edit{ cursor:grab; }
    .pin.dragging{ cursor:grabbing; }

    /* Üzən edit paneli */
    .tools{
      position:absolute; right:8px; top:8px; z-index:3;
      display:flex; gap:6px; align-items:center; background:rgba(255,255,255,.88);
      border:1px solid #e5e7eb; border-radius:999px; padding:6px 8px;
      box-shadow:0 6px 16px rgba(0,0,0,.12);
    }
    .tools .badge{ font-size:12px; color:#374151; }
    .tools .btn{ font-size:12px; padding:4px 8px; border:1px solid #e5e7eb; border-radius:999px; background:#fff; }

    /* Kart */
    .content{ padding:10px 12px 16px; }
    .card{ display:none; background:var(--card); border:1px solid #e5e7eb; border-radius:12px; padding:12px; }
    .card.active{ display:block; }
    .card h2{ margin:0 0 8px; font-size:16px; }
    .card img.media{ width:100%; height:auto; display:block; border-radius:10px; }
    .footer-note{ margin-top:10px; font-size:12px; color:var(--muted); text-align:center; }

    /* Kiçik cihazlar üçün */
    @media (max-width:420px){
      .pin{ width:32px; height:32px; font-size:13px; }
      header h1{ font-size:17px; } header p.sub{ font-size:12px; }
    }
    @media (max-width:340px){
      .pin{ width:28px; height:28px; font-size:12px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header id="appHeader">
      <h1>Baku: Once Upon a Time</h1>
      <p class="sub">Rəqəmlərə toxunaraq məlumatı açın</p>
    </header>

    <section class="map" id="mapBox">
      <!-- Üzən edit paneli -->
      <div class="tools" id="tools">
        <span class="badge" id="modeBadge">Rejim: Baxış</span>
        <button class="btn" id="toggleEdit">Düzənlə</button>
        <button class="btn" id="copyCoords">Koordinatları kopyala</button>
      </div>

      <!-- Xəritə şəkli + marker konteyneri -->
      <img src="./assets/background.jpg" alt="Xəritə" class="bg" id="bgImg" />
      <div class="pins" id="pins"></div>
    </section>

    <section class="content">
      <article class="card" id="card"></article>
      <p class="footer-note">Qeyd: Xəritə tam görünür; markerlər ekran ölçüsünə uyğun avtomatik yerləşdirilir.</p>
    </section>
  </div>

  <script>
    // ----- Kart məlumatları -----
    const ITEMS = [
      {title:"Baku Children’s Railway", html:`<img src="./assets/1.png" alt="1" class="media"><p>Baku Children’s Railway (BUDY) 1947–2009...</p>`},
      {title:"Baku Children’s Railway", html:`<img src="./assets/2.png" alt="2" class="media"><p>1990-cı illərdə diqqət azaldı... 2009-da söküldü...</p>`},
      {title:"Montin Park", html:`<img src="./assets/3.png" alt="3" class="media"><p>Cənub sərhədi dəmir yolu idi; böyük meşə park...</p>`},
      {title:"Montin Park", html:`<img src="./assets/4.png" alt="4" class="media"><p>Sonradan ərazi kiçildi, çəpərlər... Samir Xasıyev adı...</p>`},
      {title:"Karabakh Hotel", html:`<img src="./assets/5.png" alt="5" class="media"><p>1974-də tikildi; memarlar B.Şulgin, E.Melxisedekov...</p>`},
      {title:"Karabakh Hotel", html:`<img src="./assets/6.png" alt="6" class="media"><p>2004-dən sonra söküntü, dayanma, sonra tam söküldü...</p>`},
      {title:"Hacı Fərəculla Hamamı", html:`<img src="./assets/7.png" alt="7" class="media"><p>Memar Məşədi Qasım İsmayılov, 1888-ci il...</p>`},
      {title:"Hacı Fərəculla Hamamı", html:`<img src="./assets/8.png" alt="8" class="media"><p>Sonradan Yuğ Teatrı; 2016-da siyahıdan çıxarıldı...</p>`},
    ];

    /*
      Başlanğıc marker yerləri — SƏNİN FAİZ DƏYƏRLƏRİN.
      İstəsən sonradan “Koordinatları kopyala” ilə yenisini bu massivə yapışdırarsan.
    */
    let positionsPercent = [
    [
  {
    "top": "55.8%",
    "left": "42.6%"
  },
  {
    "top": "56.1%",
    "left": "28.9%"
  },
  {
    "top": "57.0%",
    "left": "71.0%"
  },
  {
    "top": "76.6%",
    "left": "68.9%"
  },
  {
    "top": "95.5%",
    "left": "47.9%"
  },
  {
    "top": "100.6%",
    "left": "35.7%"
  },
  {
    "top": "74.6%",
    "left": "22.1%"
  },
  {
    "top": "85.4%",
    "left": "10.4%"
  }
]
    ];

    // --- DOM
    const mapBox   = document.getElementById('mapBox');
    const pinsEl   = document.getElementById('pins');
    const card     = document.getElementById('card');
    const bgImg    = document.getElementById('bgImg');
    const appHeader= document.getElementById('appHeader');

    // Toolbar
    const tools         = document.getElementById('tools');
    const modeBadge     = document.getElementById('modeBadge');
    const toggleEditBtn = document.getElementById('toggleEdit');
    const copyCoordsBtn = document.getElementById('copyCoords');

    // Edit rejimi (URL və ya localStorage)
    let editMode = (new URLSearchParams(location.search).get('edit') === '1') ||
                    localStorage.getItem('editMode') === '1';

    function setModeUI(){
      modeBadge.textContent = `Rejim: ${editMode ? 'Düzənlə' : 'Baxış'}`;
      toggleEditBtn.textContent = editMode ? 'Baxış' : 'Düzənlə';
    }

    // Şəklin orijinal ölçüsü
    let natW = 0, natH = 0;
    // Piksel koordinatları (şəklin orijinal ölçüsünə görə)
    let positionsPx = [];

    function fitMapHeight(){
      const headerH = appHeader.offsetHeight || 0;
      const h = Math.max(320, window.innerHeight - headerH - 56); // 56px buffer
      mapBox.style.height = `${h}px`;
    }

    function ensureImageSize(){
      return new Promise((resolve)=>{
        if(bgImg.naturalWidth){
          natW = bgImg.naturalWidth; natH = bgImg.naturalHeight; resolve();
        }else{
          const tmp = new Image();
          tmp.src = bgImg.src;
          tmp.onload = ()=>{ natW = tmp.naturalWidth; natH = tmp.naturalHeight; resolve(); };
        }
      });
    }

    // Faiz → px (natural ölçüyə görə)
    function pctToPx(){
      positionsPx = positionsPercent.map(p=>{
        const t = parseFloat(String(p.top).replace('%',''))/100;
        const l = parseFloat(String(p.left).replace('%',''))/100;
        return { x: Math.round(natW*l), y: Math.round(natH*t) };
      });
    }

    // px → faiz (clipboard üçün)
    function pxToPercentArr(){
      return positionsPx.map(p => ({
        top:  ((p.y / natH) * 100).toFixed(1) + '%',
        left: ((p.x / natW) * 100).toFixed(1) + '%'
      }));
    }

    // Markerləri çək (contain üçün ofset + skala)
    function renderPins(){
      const wrap = mapBox.getBoundingClientRect();
      const img  = bgImg.getBoundingClientRect();

      const scale = natW ? (img.width / natW) : 1;
      const offX  = img.left - wrap.left;
      const offY  = img.top  - wrap.top;

      pinsEl.innerHTML = positionsPx.map((p,i)=>{
        const x = offX + p.x * scale;
        const y = offY + p.y * scale;
        const cls = `pin${editMode ? ' edit' : ''}`;
        return `<button class="${cls}" style="left:${x}px; top:${y}px" data-idx="${i}" aria-label="Bölmə ${i+1}">${i+1}</button>`;
      }).join('');
    }

    // Kart göstər
    function showCard(idx){
      const item = ITEMS[idx-1];
      if(!item) return;
      card.innerHTML = `<h2>${item.title}</h2>${item.html}`;
      card.classList.add('active');
      document.querySelectorAll('.pin').forEach(p=>p.classList.remove('active'));
      const active = document.querySelector(`.pin[data-idx="${idx-1}"]`);
      if(active) active.classList.add('active');
      card.scrollIntoView({behavior:'smooth', block:'start'});
    }

    // Kliklə kart aç
    document.addEventListener('click', (e)=>{
      const pin = e.target.closest('.pin');
      if(pin && !editMode){
        const id = parseInt(pin.dataset.idx, 10) + 1;
        showCard(id);
      }
    });

    // --- Sürüşdürmə: touch + mouse (Pointer Events)
    let dragging = null;
    pinsEl.addEventListener('pointerdown', (e)=>{
      const pin = e.target.closest('.pin');
      if(!pin || !editMode) return;
      dragging = pin;
      dragging.setPointerCapture(e.pointerId);
      dragging.classList.add('dragging');
    });

    pinsEl.addEventListener('pointermove', (e)=>{
      if(!dragging || !editMode) return;
      const wrap = mapBox.getBoundingClientRect();
      const img  = bgImg.getBoundingClientRect();
      const scale = img.width / natW;
      const idx = parseInt(dragging.dataset.idx, 10);

      const xOnImg = e.clientX - img.left;
      const yOnImg = e.clientY - img.top;

      const xClamped = Math.max(0, Math.min(xOnImg, img.width));
      const yClamped = Math.max(0, Math.min(yOnImg, img.height));

      positionsPx[idx] = { x: Math.round(xClamped / scale), y: Math.round(yClamped / scale) };

      dragging.style.left = ( (img.left - wrap.left) + xClamped ) + 'px';
      dragging.style.top  = ( (img.top  - wrap.top ) + yClamped ) + 'px';
    });

    function endDrag(e){
      if(!dragging) return;
      dragging.classList.remove('dragging');
      dragging.releasePointerCapture?.(e.pointerId);
      dragging = null;
    }
    pinsEl.addEventListener('pointerup', endDrag);
    pinsEl.addEventListener('pointercancel', endDrag);

    // Toolbar düymələri
    toggleEditBtn.addEventListener('click', ()=>{
      editMode = !editMode;
      localStorage.setItem('editMode', editMode ? '1' : '0');
      setModeUI(); renderPins();
    });

    copyCoordsBtn.addEventListener('click', async ()=>{
      const json = JSON.stringify(pxToPercentArr(), null, 2);
      try{
        await navigator.clipboard.writeText(json);
        copyCoordsBtn.textContent = 'Kopyalandı!';
        setTimeout(()=> copyCoordsBtn.textContent = 'Koordinatları kopyala', 1200);
      }catch{
        const ta = document.createElement('textarea');
        ta.value = json; document.body.appendChild(ta); ta.select();
        document.execCommand('copy'); document.body.removeChild(ta);
        alert('Koordinatlar kopyalandı.');
      }
    });

    // Başlat
    async function init(){
      setModeUI();
      fitMapHeight();
      await ensureImageSize();
      pctToPx();         // faizləri px-ə çevir
      renderPins();      // markerləri çək
      window.addEventListener('resize', ()=>{ fitMapHeight(); renderPins(); });
      window.addEventListener('orientationchange', ()=>{ fitMapHeight(); renderPins(); });
    }
    init();
  </script>
</body>
</html>

